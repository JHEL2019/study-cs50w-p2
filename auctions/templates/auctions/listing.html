{% extends "auctions/layout.html" %}
{% load static %}

{% block title %}
    Listing {{ listing.item | capfirst }}
{% endblock %}

{% block body %}
    <h2>Listing Details for {{ listing.item | capfirst }}</h2>

    <!-- show messages such as for etc. -->
    {% if message %}
        <div class="alert alert-warning alert-dismissible">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <strong>Warning!</strong> {{ message }}
        </div>
    {% endif %}

    <!-- Show details of listing -->
    <div class="row">
        <div class="col-5">
            <!-- place a 'watchlist' label above the image -->
            {% if listing.id in request.session.watchlist %}
                <span class="badge badge-pill badge-primary">Watchlist</span>
            {% endif %}

            <!-- show image or placeholder -->
            {% if listing.image_url %}
                <img src="{{ listing.image_url }}" alt="refence photo"  class="img-fluid">
            {% else %}
                <img src="{% static 'auctions/no_image.jpg' %}" alt="no image"  class="img-thumbnail">
            {% endif %}
        </div>

        <div class="col-7">
            <!-- details of listing -->
            <h5 class="display-4">{{ listing.item | capfirst }}</h5>

            <small class="text-muted">starting price: ${{ listing.min_price }}</small>
            {% if bid_max.amount %}
                <p>current bid: ${{ bid_max.amount }}</p>
            {% else %}
                <p>No bid submitted yet</p>
            {% endif %}
            
            <p>{{ listing.description | truncatewords:30 }}</p>
            <small class="text-muted">created: {{ listing.createdate }} by {{ listing_owner }}</small>
            
            {% if user.is_authenticated %}
                <!-- add listing to watchlist -->
                <div>
                    <form action="{% url 'listing' listing.id %}" method="POST">
                        {% csrf_token %}
                        <button class="btn btn-secondary btn-sm my-2" type="submit" value="{{ listing.id }}" name="btn-watchlist">Watchlist</button>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- For signed-in users only -->
    {% if user.is_authenticated %}
        <!-- bid for this listed item -->
        <h5>Place a Bid:</div>
        <div class="table-responsive-sm">
            <form action="{%url 'listing' listing.id %}" method="POST">
                <table class="table">
                    {% csrf_token %}
                    {{ bidform.as_p }}
                    <input type="submit" value="Submit Bid" name="btn-bid" class="btn btn-primary">
            </table>
            </form>
        </div>

        <!-- the owner shouldbe able to close the listing -->

        <!-- closed items should indicate to the winner that he won -->       

        <!-- Add a new comment to the list -->
        <h5 class="mt-4">Add your comment:</div>

        <div class="table-responsive-sm">    
            <form action="{% url 'listing' listing.id%}" method="POST">
                {% csrf_token %}
                <table class="table">
                    {{ commentform.as_table }}
                </table>
                <input type="submit" value="add comment" name="btn-comment" class="btn btn-primary">
            </form>
        </div>

        <!-- Show all comment relating to this listing -->
        <h5 class="mt-5">Comment History:</h5>
        <div class="table-responsive">
            <table class="table table-striped">
            {% for comment in comments %}            
                <tr>
                    <td>
                        <small class="text-muted">{{comment.user__username}} on {{ comment.createdate }}:</small>
                        <p>{{ comment.text }}</p>
                </td>
                </tr> 
            {% empty %}
                <tr>
                    <p>Be the first to comment</p>
                </tr>
            {% endfor %}
            </table>
        </div>

    {% endif %}
{% endblock %}